# 文章分类管理

这节我们实现文章分类管理

新建分类 `GET category/new` `POST category/new`

分类列表 `GET /category`

删除文章 `GET /category/:id/detele`

对于分类管理来说，需要管理员才可以操作。即 UserModel `isAdmin: true` 

## 分类模型设计

```javascript
// models/category.js
const mongoose = require('mongoose')
const Schema = mongoose.Schema

const CategorySchema = new Schema({
  name: {
    type: String,
    required: true
  },
  title: {
    type: String,
    required: true
  },
  desc: {
    type: String
  },
  meta: {
    createAt: {
      type: Date,
      default: Date.now()
    }
  }
})

module.exports = mongoose.model('Category', CategorySchema)
```

修改`models/posts.js` 新增一个category字段

```javascript
...
category: {
    type: Schema.Types.ObjectId,
    ref: 'Category'
}
...
```

## 分类管理主页

![category](./images/category.png)

新建分类管理控制器`routes/category.js` ，增加一个list方法来展示渲染分类主页

```javascript
const CategoryModel = require('../models/category')

module.exports = {
  async list (ctx, next) {
    const categories = await CategoryModel.find({})
    await ctx.render('category', {
      title: '新建分类',
      categories
    })
  }
}
```

编写分类管理的前端界面 `views/category.html`

```jinja2
{% extends 'views/base.html' %}
{% block body %}
{% include "views/components/header.html" %}
<div class="container margin-top">
    <div class="columns">
        <div class="column is-8 is-offset-2">
            <a href="/category/new" class="button is-small is-primary">新建分类</a>
            <table class="table margin-top is-bordered is-striped is-narrow is-hoverable is-fullwidth">
                <thead>
                    <tr>
                        <th>name</th>
                        <th>分类名</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for category in categories %}
                    <tr>
                        <td>{{category.name}}</td>
                        <td>{{category.title}}</td>
                        <td>
                            <a href="/category/{{category._id}}/delete" class="button is-small is-danger">删除</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
```

现在打开这个页面并没有分类，因为我们还没有添加分类，接下来实现新增分类功能

## 新增分类

在category控制器中新建一个create方法

```javascript
// routes/category.js
async create (ctx, next) {
    if (ctx.method === 'GET') {
        await ctx.render('create_category', {
            title: '新建分类'
        })
        return
    }
    await CategoryModel.create(ctx.request.body)
    ctx.redirect('/category')
}
```

访问 http://localhost:3000/category/new 将返回`create_category.html`

```jinja2
{% extends 'views/base.html' %}
{% block body %}
{% include "views/components/header.html" %}
<div class="container margin-top">
    <div class="columns">
        <div class="column is-8 is-offset-2">
            <form action="/category/new" method="POST">
                <div class="field">
                    <label class="label">分类名</label>
                    <div class="control">
                        <input name="name" class="input" type="text" placeholder="frontend">
                    </div>
                </div>
                <div class="field">
                    <label class="label">分类标题</label>
                    <div class="control">
                        <input name="title" class="input" type="text" placeholder="前端">
                    </div>
                </div>
                <div class="field">
                    <label class="label">描述</label>
                    <div class="control">
                        <textarea name="desc" class="textarea" placeholder="Textarea"></textarea>
                    </div>
                </div>
                <button class="button is-primary">新建分类</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
```

![create_category](/Users/lx/workspace/abc-blog/docs/images/create_category.png)

在接受到post 请求时，将分类数据存入数据库

## 删除分类

删除的功能和删除文章、删除评论基本一样

```javascript
  async destroy (ctx, next) {
    await CategoryModel.findByIdAndRemove(ctx.params.id)
    ctx.flash = { success: '删除分类成功' }
    ctx.redirect('/category')
  }
```

## 新建文章时指定分类

前面完成了分类管理，我们需要把文章指定分类，修改`views/create.html` 和 `views/edit.html`

```html
...
<div class="right-box">
    <div class="select is-small">
        <select name="category">
            <option disabled="disabled">分类</option>
            {% for category in categories %}
            <option value={{category._id}}>{{category.title}}</option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="button is-small is-primary">发布</button>
</div>
...
```

增加一个分类选择框。

同时修改`routes/post.js` 的create和edit方法，把分类信息传给模板

```javascript
...
const categories = await CategoryModel.find({})
await ctx.render('create', {
    title: '新建文章',
    categories
})
...
```

新建一篇文章，看看数据库，多了一个 category 字段存着分类的id。修改下文章详情页来展示分类名

```javascript
// routes/posts.js
async show (ctx, next) {
    const post = await PostModel.findById(ctx.params.id)
      .populate([
        { path: 'author', select: 'name' },
        { path: 'category', select: ['title', 'name'] }
    ])
    const comments = await CommentModel.find({ postId: ctx.params.id })
      .populate({ path: 'from', select: 'name' })
    await ctx.render('post', {
        title: post.title,
        post,
        comments
    })
},
```

```jinja2
// views/posts.html
{{marked(post.content) | safe}}
<p>
<a href="/posts?c={{post.category.name}}" class="tag is-primary">{{post.category.title}}</a>
</p>
```

## 权限管理

现在每一个用户登录上去都可以管理分类，我们只想要管理员可以管理，现在来增加个admin权限控制

```javascript
// routes/index.js
...
async function isAdmin (ctx, next) {
  console.log(ctx.session)
  if (!ctx.session.user) {
    ctx.flash = { warning: '未登录, 请先登录' }
    return ctx.redirect('/signin')
  }
  if (!ctx.session.user.isAdmin) {
    ctx.flash = { warning: '没有权限' }
    return ctx.redirect('back')
  }
  await next()
}
...
router.get('/category', isAdmin, require('./category').list)
router.get('/category/new', isAdmin, require('./category').create)
router.post('/category/new', isAdmin, require('./category').create)
router.get('/category/:id/delete', isAdmin, require('./category').destroy)
```

手动将数据库中一个用户 isAdmin更改为true。使用这个用户登录便可以管理分类，换一个非admin用户，将提示没有权限